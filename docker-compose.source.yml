# =============================================================================
# Docker Compose - Source Build (from local repos)
# =============================================================================
# Builds and runs services from cloned source repositories
# Apps read their own .env files - no centralized .env needed
#
# Directory Structure:
#   /root/
#   ├── atbench-ai/              (source repo with its own .env)
#   ├── atbench-ai-interviews/   (source repo with its own .env)
#   └── atbench-ai-docker/
#       ├── docker-compose.source.yml  <- THIS FILE
#       ├── ssl/
#       └── nginx/
#
# IMPORTANT: Each app's .env must use Docker hostnames:
#   - QDRANT_HOST=http://qdrant:6333
#   - REDIS_HOST=redis
#   - OLLAMA_HOST=http://host.docker.internal:11434
#
# Usage:
#   cd atbench-ai-docker
#   docker compose -f docker-compose.source.yml up -d
# =============================================================================

services:
  # ===========================================================================
  # Nginx Reverse Proxy (Port 80/443)
  # ===========================================================================
  nginx:
    image: nginx:alpine
    container_name: atbench-nginx
    ports:
      - "80:80"
      - "443:443"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - atbench-ai
      - atbench-ai-interviews
      - qdrant
      - redis
    networks:
      - atbench-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # Main Flask App - Resume Management (Port 5001)
  # ===========================================================================
  atbench-ai:
    image: python:3.12-slim
    container_name: atbench-ai
    working_dir: /app
    command: >
      bash -c "
        apt-get update && apt-get install -y --no-install-recommends curl build-essential libffi-dev libpango-1.0-0 libpangocairo-1.0-0 libgdk-pixbuf-2.0-0 shared-mime-info fonts-liberation &&
        pip install --cache-dir /pip-cache -r requirements.txt &&
        gunicorn --bind 0.0.0.0:5001 --workers 4 --threads 2 --timeout 300 app:app
      "
    expose:
      - "5001"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      # Mount source code from sibling folder (includes .env)
      - ../atbench-ai:/app
      # Pip cache (speeds up restarts)
      - pip-cache-ai:/pip-cache
      # Persistent volumes
      - atbench-uploads:/app/uploads
      - atbench-cache:/app/cache
      - atbench-logs:/app/logs
    depends_on:
      - qdrant
      - redis
    networks:
      - atbench-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 600s

  # ===========================================================================
  # Interview Service (Port 5002)
  # ===========================================================================
  atbench-ai-interviews:
    image: python:3.12-slim
    container_name: atbench-ai-interviews
    working_dir: /app
    command: >
      bash -c "
        apt-get update && apt-get install -y --no-install-recommends ffmpeg curl build-essential cmake &&
        pip install --cache-dir /pip-cache -r requirements.txt &&
        gunicorn --bind 0.0.0.0:5002 --workers 2 --threads 2 --timeout 300 app:app
      "
    expose:
      - "5002"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      # Mount source code from sibling folder (includes .env)
      - ../atbench-ai-interviews:/app
      # Pip cache (speeds up restarts)
      - pip-cache-interviews:/pip-cache
      # Persistent volumes
      - interview-cache:/app/cache
      - interview-logs:/app/logs
      - interview-uploads:/app/uploads
    depends_on:
      - qdrant
      - redis
    networks:
      - atbench-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 600s

  # ===========================================================================
  # Qdrant Vector Database
  # ===========================================================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: atbench-qdrant
    expose:
      - "6333"
      - "6334"
    volumes:
      - qdrant-storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
    networks:
      - atbench-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # Redis (Rate Limiting & Caching)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: atbench-redis
    command: redis-server --appendonly yes
    expose:
      - "6379"
    volumes:
      - redis-data:/data
    networks:
      - atbench-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  atbench-network:
    driver: bridge

volumes:
  qdrant-storage:
  redis-data:
  pip-cache-ai:
  pip-cache-interviews:
  atbench-uploads:
  atbench-cache:
  atbench-logs:
  interview-cache:
  interview-logs:
  interview-uploads:
